#!/bin/bash
#
# The MIT License (MIT)
# Copyright © 2016 Michał Dobaczewski <mdobak@gmail.com>
#

BASE_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
IMAGES_TO_RUN="images/dnsmasq-server"

. $BASE_DIR/../src/util.sh
. $BASE_DIR/../src/vbox.sh
. $BASE_DIR/../src/dnsmasq.sh
. $BASE_DIR/../src/hosts.sh
. $BASE_DIR/../src/docker.sh
. $BASE_DIR/../src/config.sh

# Prints Docker ASCII logo.
show_banner ()
{
  printf '                                           \n'
  printf '                    ##        .            \n'
  printf '              ## ## ##       ==            \n'
  printf '           ## ## ## ##      ===            \n'
  printf '       /""""""""""""""""\\___/ ===         \n'
  printf '  ~~~ {~~ ~~~~ ~~~ ~~~~ ~~ ~ /  ===- ~~~   \n'
  printf '       \\______ o          __/             \n'
  printf '         \\    \\        __/               \n'
  printf '          \\____\\______/                  \n'
  printf '                                           \n'
}

# Print help message.
show_help ()
{
  echo
  echo 'Usage: ./docker-dev-env [OPTIONS] [DIRECTORIES...]';
  echo
  echo 'Options:'
  echo
  echo '-h, --help                      Print help message.'
  echo '-v, --verbose                   Run with a lot of debugging output.'
  echo '-m, --mount-dir <dir>           The directory where a NFS folder will be mount.'
  echo '-H, --hostname-suffix <suffix>  The suffix appended to hostnames. Default ".loc".'
  echo '--skip-setup-vbox-net           Skip the VirtualBox bridged network configuration.'
  echo '--skip-setup-vbox-nfs-sharing   Skip the VirtualBox NFS configuration.'
  echo '--skip-setup-containers-host    Skip the /etc/hosts file configuration on containers.'
  echo

  exit 0
}

# Parses arguments passed to this script. Should be invoked with $@ as argument.
# An image's names to build are stored in IMAGES_TO_RUN.
parse_args ()
{
  while [[ $# > 0 ]]; do
    ARG="$1"

    if [[ $ARG == "-v" || $ARG == "--verbose" ]]; then
      VERBOSE=1
    elif [[ $ARG == "-h" || $ARG == "--help" ]]; then
        SHOW_HELP=$true
    elif [[ $ARG == "-m" || $ARG == "--mount-dir" ]]; then
      shift
      MOUNT_DIR=$1
    elif [[ $ARG == "-H" || $ARG == "--hostname-suffix" ]]; then
      shift
      HOSTNAME_SUFFIX=$1
    elif [[ $ARG == "--skip-setup-vbox-net" ]]; then
      SETUP_VBOX_NETWORK=$false
    elif [[ $ARG == "--skip-setup-nfs-sharing" ]]; then
      SETUP_VBOX_NFS_SHARING=$false
    elif [[ $ARG == "--skip-setup-containers-host" ]]; then
      SETUP_CONTAINERS_HOSTS=$false
    else
      IMAGES_TO_RUN="$IMAGES_TO_RUN $ARG"
    fi

    shift
  done
}

# Takes one argument, a variable name and stores in it path where the Docker
# volumes will be mounted.
#
# $1 - Variable name.
setup_mount_dir ()
{
  local _MOUNT_DIR=""

  if is_mac; then
    _MOUNT_DIR=$MACOS_MOUNT_DIR
  elif is_linux; then
    _MOUNT_DIR=$LINUX_MOUNT_DIR
  fi

  mkdir -p $_MOUNT_DIR
  eval "$1=$_MOUNT_DIR"

  echo_step_info "The Docker volumes will be mounted in $_MOUNT_DIR"
}

# Runs image.sh scripts stored in an image directory which builds or starts
# the Docker images. Images to build are defined in an IMAGES_TO_RUN variable.
build_images ()
{
  local MOUNT_DIR=$1
  shift 1

  for IMAGE_DIR in $IMAGES_TO_RUN; do
    if [[ $IMAGE_DIR == @* ]]; then
      DIR=$BASE_DIR/../images/${IMAGE_DIR:1}
    else
      DIR=$IMAGE_DIR
    fi

    if ! [[ -f $DIR/DevEnvConf ]]; then
      echo_fatal "Configuration file $DIR/DevEnvConf do not exists!"
    fi

    . $DIR/DevEnvConf

    if [[ -z $IMAGE ]]; then
      IMAGE=$NAME
    fi

    setup_dev_container "$NAME" "$DIR" $IMAGE $ARGS
  done
}

show_banner
parse_args $@

if [[ $SHOW_HELP == $true ]]; then
  show_help
fi

sudo_prompt
check_os_support
check_requirements
setup_mount_dir MOUNT_DIR

if [[ $SETUP_VBOX_NETWORK == $true ]]; then
  setup_vbox_network
  setup_vbox_gw
fi

if [[ $SETUP_VBOX_NFS_SHARING == $true ]]; then
  setup_vbox_nfs
fi

start_docker_machine
build_images $MOUNT_DIR $@

if [[ $SETUP_HOST_DNSMASQ == $true ]]; then
  setup_host_dnsmasq
fi

if [[ $SETUP_CONTAINERS_DNSMASQ == $true ]]; then
  setup_containers_dnsmasq
fi

if [[ $SETUP_CONTAINERS_HOSTS == $true ]]; then
  setup_containers_host_files
fi

setup_dnsmasq_config
setup_dnsmasq_resolv

docker_remove_untagged_images

echo
echo_success "All done!"
echo
